x-default: &default
  restart: unless-stopped
  volumes:
    - &localtime /etc/localtime:/etc/localtime:ro
    - &timezone /etc/timezone:/etc/timezone:ro
  logging:
    driver: json-file
    options:
      max-size: 100m

services:
  gitlab:
    <<: *default
    image: gitlab/gitlab-ce:${GITLAB_VERSION:-18.4.0-ce.0}
    ports:
      - "${GITLAB_PORT_OVERRIDE_HTTPS:-5443}:443"
      - "${GITLAB_PORT_OVERRIDE_HTTP:-5080}:80"
      - "${GITLAB_PORT_OVERRIDE_SSH:-5022}:22"
    volumes:
      - *localtime
      - *timezone
      - ./config:/etc/gitlab
      - gitlab_logs:/var/log/gitlab
      - gitlab_data:/var/opt/gitlab
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 8G
        reservations:
          cpus: '1.0'
          memory: 4G

volumes:
  gitlab_logs:
  gitlab_data:

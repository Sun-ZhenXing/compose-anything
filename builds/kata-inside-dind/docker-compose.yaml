# Kata Containers inside Docker-in-Docker
# A VM-based container runtime running inside a Docker container with Docker daemon
# See README.md for usage instructions

x-defaults: &defaults
  restart: unless-stopped
  logging:
    driver: json-file
    options:
      max-size: 100m
      max-file: "3"

services:
  kata-dind:
    <<: *defaults
    image: ${GLOBAL_REGISTRY:-}alexsuntop/kata-inside-dind:${KATA_DIND_VERSION:-0.2.0}
    build:
      context: .
      dockerfile: Dockerfile
      args:
        DEBIAN_VERSION: ${DEBIAN_VERSION:-13.2-slim}
        KATA_VERSION: ${KATA_VERSION:-3.24.0}
        FIRECRACKER_VERSION: ${FIRECRACKER_VERSION:-1.14.0}
    privileged: true
    devices:
      - /dev/kvm:/dev/kvm
      - /dev/net/tun:/dev/net/tun
      - /dev/vhost-net:/dev/vhost-net
      - /dev/vhost-vsock:/dev/vhost-vsock
    volumes:
      - kata_data:/var/lib/kata
      - docker_data:/var/lib/docker
      - /lib/modules:/lib/modules:ro
    environment:
      - TZ=${TZ:-UTC}
      - DOCKER_TLS_CERTDIR=${DOCKER_TLS_CERTDIR:-}
      - KATA_LOGGING_LEVEL=${KATA_LOGGING_LEVEL:-info}
    healthcheck:
      test: ["CMD", "docker", "info"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: ${KATA_DIND_CPU_LIMIT:-2.00}
          memory: ${KATA_DIND_MEMORY_LIMIT:-4G}
        reservations:
          cpus: ${KATA_DIND_CPU_RESERVATION:-0.50}
          memory: ${KATA_DIND_MEMORY_RESERVATION:-1G}

volumes:
  kata_data:
  docker_data:
